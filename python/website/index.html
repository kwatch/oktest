<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title>Oktest - a new style testing library -</title>
<link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<div class="document" id="readme">
<h1 class="title">Oktest - a new style testing library -</h1>

<p>$Release: 0.7.0 $</p>
<div class="section" id="overview">

<h2>Overview</h2>
<p>Oktest is a new-style testing library for Python.</p>
<pre class="literal-block">
from oktest import ok
ok (x) &gt; 0                 # same as assert_(x &gt; 0)
ok (s) == 'foo'            # same as assertEqual(s, 'foo')
ok (s) != 'foo'            # same as assertNotEqual(s, 'foo')
ok (f).raises(ValueError)  # same as assertRaises(ValueError, f)
ok (u'foo').is_a(unicode)  # same as assert_(isinstance(u'foo', unicode))
NG (u'foo').is_a(int)      # same as assert_(not isinstance(u'foo', int))
ok ('A.txt').is_file()     # same as assert_(os.path.isfile('A.txt'))
NG ('A.txt').is_dir()      # same as assert_(not os.path.isdir('A.txt'))
</pre>
<p>You can use ok() instead of 'assertXxx()' in unittest.</p>
<p>Oktest requires Python 2.4 or later (3.x is supported).</p>
<p>See <a href="CHANGES.txt">CHANGES.txt</a> for changes.</p>
<p>NOTICE!! Oktest is a young project and specification may change in the future.</p>
</div>
<div class="section" id="download">

<h2>Download</h2>
<p><a class="reference external" href="http://pypi.python.org/pypi/Oktest/">http://pypi.python.org/pypi/Oktest/</a></p>
<p>Installation:</p>
<pre class="literal-block">
## if you have installed easy_install:
$ sudo easy_install Oktest
## or download Oktest-0.7.0.tar.gz and install it
$ wget http://pypi.python.org/packages/source/O/Oktest/Oktest-0.7.0.tar.gz
$ tar xzf Oktest-0.7.0.tar.gz
$ cd Oktest-0.7.0/
$ sudo python setup.py install
</pre>
</div>
<div class="section" id="example">

<h2>Example</h2>
<p>The following is a short example.</p>
<pre class="literal-block">
from oktest import ok, NG, run

class Example1Test(object):

    def test_add(self):
        ok (1+1) == 1

    def test_sub(self):
        ok (1-1) == 0

if __name__ == '__main__':
    run()
</pre>
<p>The following is a long example.</p>
<pre class="literal-block">
import sys, os
from oktest import ok, NG, run

## no need to extend TestCase class
class Example1Test(object):

    ## invoked only once before all tests
    &#64;classmethod
    def before_all(cls):
        os.mkdir('tmp.d')

    ## invoked only once after all tests done
    &#64;classmethod
    def after_all(cls):
        import shutil
        shutil.rmtree('tmp.d')

    ## invoked before each test
    def before(self):   # or setUp(self)
        self.val = ['aaa', 'bbb', 'ccc']

    ## invoked after each test
    def after(self):    # or tearDown(self)
        pass

    ## test methods
    def test_valtype(self):
        ok (self.val).is_a(list)

    def test_length(self):
        ok (len(self.val)) == 3


## 'ok()' is available with unittest.TestCase
import unittest
class Example2Test(unittest.TestCase):

    def setUp(self):
        self.val = ['aaa', 'bbb', 'ccc']

    def test_valtype(self):
        ok (self.val).is_a(list)

    def test_length(self):
        ok (len(self.val)) == 3

## invoke tests
if __name__ == '__main__':
    run(Example1Test, Example2Test)
    ## or
    #run(r'.*Test$')  # specify class names by regular expression
    ## or
    #run()            # same as run(r'.*(Test|TestCase|_TC)$')
</pre>
<p>NOTE: Since Oktest 0.5, it is recommended to describe test scpecification by spec() helper for readability.
See the example at the bottom of this document.</p>
</div>
<div class="section" id="assertion-reference">

<h2>Assertion Reference</h2>
<dl class="docutils">
<dt>ok (x) == y</dt>
<dd>Raise AssertionError unless x == y.</dd>
<dt>ok (x) != y</dt>
<dd>Raise AssertionError unless x != y.</dd>
<dt>ok (x) &gt; y</dt>
<dd>Raise AssertionError unless x &gt; y.</dd>
<dt>ok (x) &gt;= y</dt>
<dd>Raise AssertionError unless x &gt;= y.</dd>
<dt>ok (x) &lt; y</dt>
<dd>Raise AssertionError unless x &lt; y.</dd>
<dt>ok (x) &lt;= y</dt>
<dd>Raise AssertionError unless x &lt;= y.</dd>
<dt>ok (x).in_delta(y, delta)</dt>
<dd>Raise AssertionError unless y-delta &lt; x &lt; y+delta.</dd>
<dt>ok (x).in_(y)</dt>
<dd>Raise AssertionError unless x in y.</dd>
<dt>ok (x).contains(y)</dt>
<dd>Raise AssertionError unless y in x. This is opposite of in_().</dd>
<dt>ok (x).is_(y)</dt>
<dd>Raise AssertionError unless x is y.</dd>
<dt>ok (x).is_not(y)</dt>
<dd>Raise AssertionError if x is y.</dd>
<dt>ok (x).is_a(y)</dt>
<dd>Raise AssertionError unless isinstance(x, y).</dd>
<dt>ok (x).has_attr(y)</dt>
<dd>Raise AssertionError unless hasattr(x, y).</dd>
<dt>ok (x).matches(y[, flag=None])</dt>
<dd>If y is a string, raise AssertionError unless re.search(y, x).
If y is a re.pattern object, raise AssertionError unless y.search(x).
You can pass flag such as <tt class="docutils literal">re.M | re.S</tt>.</dd>
<dt>ok (path).is_file()</dt>
<dd>Raise AssertionError unless os.path.isfile(path).</dd>
<dt>ok (path).is_dir()</dt>
<dd>Raise AssertionError unless os.path.isdir(path).</dd>
<dt>ok (path).exists()</dt>
<dd>Raise AssertionError unless os.path.exists(path).</dd>
<dt>ok (func).raises(error_class[, errmsg=None])</dt>
<dd><p class="first">Raise AssertionError unless func() raises error_class.
It sets raised exception into 'func.exception' therefore you can do another test with raised exception object.</p>
<pre class="last literal-block">
obj = &quot;foobar&quot;
def f():
    obj.name
ok (f).raises(AttributeError, &quot;'str' object has no attribute 'name'&quot;)
ok (f.exception.message) == &quot;'str' object has no attribute 'name'&quot;
</pre>
</dd>
<dt>NG (x)</dt>
<dd><p class="first">Opposite of ok(x). For example, 'NG (&quot;foo&quot;).matches(r&quot;[0-9]+&quot;)' is True.</p>
<pre class="last literal-block">
fname = 'file.txt'
open(fname, 'w').write('foo')
ok (fname).is_file()            # file exists
os.unlink(fname)
NG (fname).is_file()        # file doesn't exist
</pre>
</dd>
<dt>not_ok (x)</dt>
<dd>Same as NG(x).</dd>
</dl>
<p>Oktest allows you to define custom assertion functions.
See Tips section.</p>
</div>
<div class="section" id="unified-diff">

<h2>Unified Diff</h2>
<p>'ok(x) == y' prints unified diff (diff -u) if:</p>
<ul class="simple">
<li>both x and y are str or unicode</li>
<li>and x != y</li>
<li>and oktest.DIFF is True or 'repr'</li>
<li>and invoked with oktest.run()</li>
</ul>
<p>For example:</p>
<pre class="literal-block">
## foo_test.py
from oktest import *

class FooTest(object):

    def test1(self):
        s1 = ( &quot;AAA\n&quot;
               &quot;BBB\n&quot;
               &quot;CCC\n&quot; )
        s2 = ( &quot;AAA\n&quot;
               &quot;CCC\n&quot;
               &quot;DDD\n&quot; )
        ok (s1) == s2

if __name__ == '__main__':
    run(FooTest)
</pre>
<p>If you run this script, you'll find that unified diff is displayed.</p>
<p>Output result:</p>
<pre class="literal-block">
$ python foo_test.py
### FooTest
f
Failed: FooTest#test1()
   'AAA\nBBB\nCCC\n' == 'AAA\nCCC\nDDD\n' : failed.
   foo_test.py:13:  ok (s1) == s2
--- expected
+++ actual
&#64;&#64; -1,3 +1,3 &#64;&#64;
 AAA
+BBB
 CCC
-DDD
</pre>
<p>If you set 'oktest.DIFF' to 'repr', each line is preprocessed by repr(). This is very useful to show non-visible characters. For example:</p>
<pre class="literal-block">
$ vi foo_test.py    # add 'import oktest; oktest.DIFF = repr'
$ python foo_test.py
### FooTest
f
Failed: FooTest#test1()
   'AAA\nBBB\nCCC\n' == 'AAA\nCCC\nDDD\n' : failed.
   hoge.py:15:  ok (s1) == s2
--- expected
+++ actual
&#64;&#64; -1,3 +1,3 &#64;&#64;
 'AAA\n'
+'BBB\n'
 'CCC\n'
-'DDD\n'
</pre>
<p>If you set 'oktest.DIFF' to False, unified diff is not displayed.</p>
<p>Notice that this feature is only available with oktest.run() and not available with unittest module.</p>
</div>
<div class="section" id="tracer">

<h2>Tracer</h2>
<p>Oktest provides <tt class="docutils literal">Tracer</tt> class which can be stub or mock object.
<tt class="docutils literal">Tracer</tt> class can:</p>
<ul class="simple">
<li>Create fake object.</li>
<li>Trace method or function call.</li>
<li>Fake method, or function.</li>
</ul>
<p>In any case, <tt class="docutils literal">Tracer</tt> object records both arguments and return-value of method or function calls.</p>
<p>Example to create fake object:</p>
<pre class="literal-block">
## create fake objects
from oktest.tracer import Tracer
tr = Tracer()
foo = tr.fake_obj(m1=100, m2=200)   # method name and return-value
bar = tr.fake_obj(m3=lambda self, x: x+1)  # method name and body
## call fake methods
ok (bar.m3(0))     == 1
ok (foo.m2(1,2,3)) == 200    # any argument can be passed
ok (foo.m1(x=123)) == 100    # any argument can be passed
## check results
ok (repr(tr[0]))   == 'm3(0) #=&gt; 1'
ok (repr(tr[1]))   == 'm2(1, 2, 3) #=&gt; 200'
ok (repr(tr[2]))   == 'm1(x=123) #=&gt; 100'
</pre>
<p>There are several ways to check results:</p>
<pre class="literal-block">
from oktest.tracer import Tracer
tr = Tracer()
obj = tr.fake_obj(meth=9)
ok (obj.meth(1, 2, x=3)) == 9
## check results
ok (repr(tr[0]))  == 'meth(1, 2, x=3) #=&gt; 9'
## or
ok (tr[0].list()) == [obj, 'meth', (1, 2), {'x': 3}, 9]
## or
ok (tr[0])        == [obj, 'meth', (1, 2), {'x': 3}, 9]
## or
ok (tr[0].receiver).is_(obj)
ok (tr[0].name)   == 'meth'
ok (tr[0].args)   == (1, 2)
ok (tr[0].kwargs) == {'x': 3}
ok (tr[0].ret)    == 9
</pre>
<p>Example to trace method call:</p>
<pre class="literal-block">
class Foo(object):
    def m1(self, x):
        return x + 1
    def m2(self, y):
        return y + 1
obj = Foo()
## trace methods
from oktest.tracer import Tracer
tr = Tracer()
def dummy(original_func, *args, **kwargs):
    #return original_func(*args, **kwargs)
    return 100
tr.fake_method(obj, m1=dummy, m2=200)
## call methods
ok (obj.m1(1)) == 100
ok (obj.m2(2)) == 200
## check results
ok (tr[0]) == [obj, 'm1', (1,), {}, 100]
ok (tr[1]) == [obj, 'm2', (2,), {}, 200]
</pre>
<p>Example to trace function call:</p>
<pre class="literal-block">
def f(x):
    return x+1
def g(y):
    return f(y+1) + 1
## trace functions
from oktest.tracer import Tracer
tr = Tracer()
f = tr.trace_func(f)
g = tr.trace_func(g)
## call functions
ok (g(0)) == 3
## check results
ok (tr[0]) == [None, 'g', (0,), {}, 3]
ok (tr[1]) == [None, 'f', (1,), {}, 2]
</pre>
<p>Example to fake method call:</p>
<pre class="literal-block">
class Foo(object):
    def m1(self, x):
        return x + 1
    def m2(self, y):
        return y + 1
obj = Foo()
## fake methods
from oktest.tracer import Tracer
tr = Tracer()
def dummy(original_func, *args, **kwargs):
    #return original_func(*args, **kwargs)
    return 100
tr.fake_method(obj, m1=dummy, m2=200)
## call method
ok (obj.m1(1)) == 100
ok (obj.m2(2)) == 200
## check results
ok (tr[0]) == [obj, 'm1', (1,), {}, 100]
ok (tr[1]) == [obj, 'm2', (2,), {}, 200]
</pre>
<p>Example to fake function call:</p>
<pre class="literal-block">
def f(x):
    return x*2
## fake a function
def dummy(original_func, x):
    #return original_func(x)
    return 'x=%s' % repr(x)
from oktest.tracer import Tracer
tr = Tracer()
f = tr.fake_func(f, dummy)
## call function
ok (f(3))  == 'x=3'
## check results
ok (tr[0]) == [None, 'f', (3,), {}, 'x=3']
</pre>
</div>
<div class="section" id="helpers-reference">

<h2>Helpers Reference</h2>
<div class="section" id="oktest-module">

<h3><tt class="docutils literal">oktest</tt> module</h3>
<dl class="docutils">
<dt>run(*classes)</dt>
<dd><p class="first">Invokes tests of each class.
Argument can be regular expression string.</p>
<pre class="last literal-block">
import oktest
oktest.run(FooTest, BarTest)  # invokes FooTest and BarTest
oktest.run(r'.*Test$')        # invokes FooTest, BarTest, and so on
oktest.run()                  # same as oktest.run('.*(Test|TestCase|_TC)$')
</pre>
</dd>
<dt>spec(description)</dt>
<dd><p class="first">Represents spec description. This is just a marker function, but very useful for readability.
<strong>It is recommended to use spec() helper for readability of tests.</strong></p>
<pre class="last literal-block">
class NumericTest(object):
    def test_integer(self):
        with spec(&quot;1+1 should be equal to 2.&quot;):
            ok (1+1) == 2
        with spec(&quot;1/0 should be error.&quot;):
            def f(): 1/0
            ok (f).raises(ZeroDivisionError,
                          &quot;integer division or modulo by zero&quot;)
        ## tips: 'for' statement is available instead of 'with' for Python 2.4
        for _ in spec(&quot;1+1 should be equal to 2.&quot;):
            ok (1+1) == 2
</pre>
</dd>
</dl>
</div>
<div class="section" id="oktest-helper-module">

<h3><tt class="docutils literal">oktest.helper</tt> module</h3>
<dl class="docutils">
<dt>chdir(dirname)</dt>
<dd><p class="first">Change current directory to dirname temporarily.</p>
<pre class="last literal-block">
import os
cwd = os.getcwd()                         # current working directory
with chdir(&quot;/var/tmp&quot;):
    assert os.getcwd() == &quot;/var/tmp&quot;      # current directory is changed!
    # do something
assert os.getcwd() == cwd                 # back to the original place
## or
def fn():
    assert os.getcwd() == &quot;/var/tmp&quot;
    # do something
chdir(&quot;/var/tmp&quot;).run(fn)
</pre>
</dd>
<dt>rm_rf(filename, dirname, ...)</dt>
<dd>Remove file or directory recursively.</dd>
</dl>
</div>
<div class="section" id="oktest-dummy-module">

<h3><tt class="docutils literal">oktest.dummy</tt> module</h3>
<dl class="docutils">
<dt>dummy_file(filename, content)</dt>
<dd><p class="first">Create dummy file with specified content.</p>
<pre class="last literal-block">
import os
from oktest.helper import dummy_file
assert not os.path.exists(&quot;A.txt&quot;)        # file doesn't exist
with dummy_file(&quot;A.txt&quot;, &quot;aaa&quot;):
    assert os.path.isfile(&quot;A.txt&quot;)        # file is created!
    # do something
assert not os.path.exists(&quot;A.txt&quot;)        # file is removed
## or
def fn():
    assert os.path.isfile(&quot;A.txt&quot;)
dummy_file(&quot;A.txt&quot;, &quot;aaa&quot;).run(fn)
</pre>
</dd>
<dt>dummy_dir(dirname)</dt>
<dd><p class="first">Create dummy directory.</p>
<pre class="last literal-block">
import os
from oktest.helper import dummy_dir
assert not os.path.exists(&quot;tmpdir&quot;)       # directory doesn't exist
with dummy_dir(&quot;tmpdir&quot;):
    assert os.path.isdir(&quot;tmpdir&quot;)        # directory is created!
    # do something
assert not os.path.exists(&quot;tmpdir&quot;)       # directory is removed
## or
def fn():
    assert os.path.isdir(&quot;tmpdir&quot;)
dummy_dir(&quot;tmpdir&quot;).run(fn)
</pre>
</dd>
<dt>dummy_values(dictionary, items_=None, **kwargs):</dt>
<dd><p class="first">Change dictionary's values temporarily.</p>
<pre class="last literal-block">
from oktest.helper import dummy_values
d = {'A':10, 'B':20}
with dummy_values(d, A=1000, X=2000):
    assert d['A'] == 1000                 # dictionary values are changed!
    assert d['B'] == 20
    assert d['X'] == 2000
    # do something
assert d == {'A':10, 'B':20}              # values are backed
## or
def fn():
    assert d['A'] == 1000
dummy_values(d, A=1000, X=2000).run(fn)
</pre>
</dd>
<dt>dummy_attrs(object, items_=None, **kwargs):</dt>
<dd><p class="first">Change object's attributes temporarily.
This is same as dummy_values(object.__dict__, **kwargs).</p>
<pre class="last literal-block">
from oktest.helper import dummy_attrs
class Hello(object):
    pass
obj = Hello()
obj.x = 10
obj.y = 20
with dummy_attrs(obj, x=90, z=100):
    assert obj.x == 90                    # attributes are changed!
    assert obj.y == 20
    assert obj.z == 100
    # do something
assert obj.x == 10                        # attributes are backed
assert obj.y == 20
assert not hasattr(obj, 'z')
## or
def fn():
    assert obj.x == 90
dummy_attrs(obj, x=90, z=100).run(fn)
</pre>
</dd>
<dt>dummy_io(stdin_content=None, func=None):</dt>
<dd><p class="first">Set dummy I/O to sys.stdout, sys.stderr, and sys.stdin.</p>
<pre class="last literal-block">
with dummy_io(&quot;SOS&quot;) as d_io:
    assert sys.stdin.read() == &quot;SOS&quot;
    print(&quot;Haruhi&quot;)
assert d_io.stdout == &quot;Haruhi\n&quot;
assert d_io.stderr == &quot;&quot;
## or
def fn():
    assert sys.stdin.read() == &quot;SOS&quot;
    print(&quot;Haruhi&quot;)
d_io = dummy_io(&quot;SOS&quot;)
d_io.run(fn)
assert d_io.stdout == &quot;Haruhi\n&quot;
</pre>
</dd>
</dl>
</div>
<div class="section" id="oktest-tracer-module">

<h3><tt class="docutils literal">oktest.tracer</tt> module</h3>
<dl class="docutils">
<dt>tracer():</dt>
<dd>Return tracer object. See the above section for details.</dd>
</dl>
</div>
</div>
<div class="section" id="tips">

<h2>Tips</h2>
<ul>
<li><p class="first">You can define your own custom assertion function.</p>
<pre class="literal-block">
## define custom assertion function
import oktest
&#64;oktest.assertion
def startswith(self, arg):
    boolean = self.target.startswith(arg)
    if boolean == self.expected:
        return True
    self.failed(&quot;%r.startswith(%r) : failed.&quot; % (self.target, arg))

## how to use
from oktest import ok
ok (&quot;Sasaki&quot;).startswith(&quot;Sas&quot;)
</pre>
</li>
<li><p class="first">It is possible to chain assertion methods.</p>
<pre class="literal-block">
## chain assertion methods
ok (&quot;sos&quot;.upper()).is_a(str).matches(r'^[A-Z]+$')
</pre>
</li>
<li><p class="first">If you call ok() or not_ok() but forget to do assertion, oktest warns it.</p>
<pre class="literal-block">
import oktest
from oktest import ok, not_ok

class FooTest(object):
    def test_1(self):
        #ok (1+1) == 2
        ok (1+1)         # missing assertion

oktest.run()   #=&gt; warning: ok() is called but not tested.
</pre>
</li>
<li><p class="first">You can filter test methods to invoke by environment variable $TEST. For example, 'export TEST=&quot;ex[0-9]+&quot;' will invokes 'test_ex1()', 'test_ex2()', ..., but not invoke 'test_1()', 'test_2()', and so on.</p>
<pre class="literal-block">
### filter test by name
$ TEST='ex[0-9]' python test/foobar_test.py
</pre>
</li>
<li><p class="first">If you want to output format, create oktest.Reporter subclass and set it to oktest.REPORTER variable.</p>
</li>
</ul>
</div>
<div class="section" id="todo">

<h2>ToDo</h2>
<ul class="simple">
<li>[v] print unified diff when two strings are different</li>
<li>[_] improve reporters</li>
<li>[_] make package(?)</li>
<li>[v] report assertion objects which are not tested</li>
</ul>
</div>
<div class="section" id="license">

<h2>License</h2>
<p>$License: MIT License $</p>
</div>
<div class="section" id="copyright">

<h2>Copyright</h2>
<p>$Copyright: copyright(c) 2010-2011 kuwata-lab.com all rights reserved $</p>
</div>
</div>
</body>
</html>
